receivers:
  prometheus:
    config:
      scrape_configs:
        - job_name: ${SERVICE_NAME}
          metrics_path: /actuator/prometheus
          scrape_interval: 15s
          static_configs:
            - targets: ['127.0.0.1:${APP_PORT}']
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
processors:
  resourcedetection/ecs:
    detectors: [ecs]
    timeout: 2s
    override: false
  resource/ecs_labels:
    attributes:
      - key: aws.ecs.task.id
        action: extract
        pattern: '^(?P<ecs_task_short>[0-9a-f]{6}).*'
      - key: ecs_task
        action: upsert
        from_attribute: ecs_task_short
      - key: ecs_task_short
        action: delete
      - key: cloud.account.id
        action: delete
      - key: cloud.region
        action: delete
      - key: cloud.provider
        action: delete
      - key: cloud.platform
        action: delete
      - key: cloud.availability_zone
        action: delete
      - key: aws.ecs.cluster.arn
        action: delete
      - key: aws.ecs.task.arn
        action: delete
      - key: aws.ecs.task.family
        action: delete
      - key: aws.ecs.task.id
        action: delete
      - key: aws.ecs.task.revision
        action: delete
      - key: aws.ecs.launchtype
        action: delete
      - key: aws.log.group.arns
        action: delete
      - key: aws.log.group.names
        action: delete
      - key: aws.log.stream.arns
        action: delete
      - key: aws.log.stream.names
        action: delete
  attributes/http_normalize:
    actions:
      - key: http.request.method
        action: upsert
        from_attribute: method
      - key: url.path
        action: upsert
        from_attribute: uri
      - key: http.route
        action: upsert
        from_attribute: uri
      - key: http.response.status_code
        action: upsert
        from_attribute: status
      - key: http.response.status_code
        action: convert
        converted_type: int
      - key: http.method
        action: upsert
        from_attribute: method
      - key: http.status_code
        action: upsert
        from_attribute: http.response.status_code
  filter/drop_actuator_spans:
    traces:
      span:
        - 'attributes["uri"] == "/actuator/prometheus"'
        - 'attributes["uri"] == "/actuator/health"'
        - 'attributes["uri"] == "/actuator/health/liveness"'
        - 'attributes["uri"] == "/actuator/health/readiness"'
extensions:
  sigv4auth:
    region: ${AWS_DEFAULT_REGION}
exporters:
  prometheusremotewrite:
    endpoint: ${APS_REMOTE_WRITE_ENDPOINT}
    auth:
      authenticator: sigv4auth
    resource_to_telemetry_conversion:
      enabled: true
  awsxray:
    region: ${AWS_DEFAULT_REGION}
service:
  telemetry:
    logs:
      level: info
  extensions: [sigv4auth]
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [resourcedetection/ecs, resource/ecs_labels]
      exporters: [prometheusremotewrite]
    traces:
      receivers: [otlp]
      processors: [attributes/http_normalize, filter/drop_actuator_spans]
      exporters: [awsxray]